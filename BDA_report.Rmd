---
title: "BDA_report"
author: "曹霞 黄雅雯 赵玉娇"
date: "2019/5/18"
output:
  html_notebook:
    highlight: monochrome
    number_sections: yes
    theme: united
    toc: yes
  github_document: default
  html_document:
    df_print: paged
    toc: yes
---

# **团队成员简介**

## **团队分工**

```{r setup,echo=FALSE}
knitr::opts_chunk$set(warning = FALSE,message = FALSE)
library(tidyverse)
library(sjPlot)
STUDENT_NAME <- c("曹霞","黄雅雯","赵玉娇")
STUDENT_NUMBER <- c("201643030","201638058","201629019")
WORK <- c("1. 搜集有关“幸福感”的背景资料，包含幸福悖论、宗教、性别认同、住房等相关方面的背景  2. 主笔报告团队概况部分  3. 整理GitHub相关学习资料并撰写Github工作报告  4. 可视化分析教育、地域、社会认知等方面变量与主观幸福感的关系  5. 建模分析(有序因变量回归分析、神经网络分析）","1. 搜集有关“幸福感”的背景资料，包含政策、世界幸福感排名等相关资料  2. 主笔数据预处理部分  3. 可视化宗教信仰、生活方式、家庭状况等方面变量与主观幸福感的关系  4. 建模分析(多元线性回归及主成分分析、二分变量回归分析)","1. 搜集有关“幸福感”的背景资料，包含政治、经济等方面的背景 2. 主笔数据来源以及问题背景部分  3. 可视化身心健康、工作就业等变量与主观幸福感的关系  4. 建模分析(泊松回归分析、决策树建模分析)")

teamtable <- knitr::kable(
  data.frame(STUDENT_NAME,STUDENT_NUMBER,WORK),
  caption = "WORK DISTRIBUTION",
  align = c('c','c','l')
) 
teamtable

```

## **成员特长**

- 曹霞
  - 擅长于搜集资料与数据可视化，机器学习、数学、统计学等相关领域均有知识储备，具有较好的分析能力
- 黄雅雯
  - 擅长于数学与计算机科学，机器学习、统计学等相关领域均有知识储备，具有较好的实践能力
- 赵玉娇
  - 擅长于统计学与数学，机器学习、计算机科学等相关领域均有知识储备，具有较好的思维能力
  
团队知识结构如下图所示：

```{r ability,echo=FALSE}
ability <- data.frame(collection=c(8,5,5),visualization=c(7,6,6),machine_learning=c(4,4,5),computer_science=c(6,7,6),statistic=c(6,5,7),math=c(4,6,6),row.names=c("曹 霞","黄雅雯","赵玉娇"))
barplot(as.matrix(ability),col=cm.colors(5),names.arg=c("资料搜集","数据可视化","机器学习","计算机科学","统计学","数学"),legend=rownames(ability),args.legend=c(x=7.5,y=21.6),cex.names = 0.7,xlab="团队技能")
```

## **协同方式**
-  Github
-  实时讨论、及时沟通

# **数据来源**
## **下载来源**
　　数据下载来源为阿里云天池大数据竞赛新人赛，赛题为“快来一起挖掘幸福感！”下载地址：https://tianchi.aliyun.com/competition/entrance/231702/information (下载前需登陆报名)
  
## **原始出处**
　　赛题所用数据的最初来源为中国人民大学中国调查与数据中心主持之《中国综合社会调查（CGSS）》项目2015年度的调查问卷，从中选取了多组变量，包括个体变量（性别、年龄、地域、职业、健康、婚姻与政治面貌等等）、家庭变量（父母、配偶、子女、家庭资本等等）、社会态度（公平、信用、公共服务等等）以及幸福感水平。  
　　中国综合社会调查（Chinese General Social Survey，CGSS），是中国第一个全国性、综合性、连续性的大型社会调查项目。目的是通过定期、系统地收集中国人与中国社会各个方面的数据，总结社会变迁的长期趋势，探讨具有重大理论和现实意义的社会议题，推动国内社会科学研究的开放性与共享性，为政府决策与国际比较研究提供数据资料。
  
# **研究背景**
## **历史背景**
>　　国际上对幸福感的研究起始于二战后，从20世纪60年代逐步发展起来。Easterlin（1974，2010）最先研究了幸福与收入之间的关系，提出了“幸福悖论”，也称为“伊斯特林悖论”，即随着物质产品的丰富和收入水平的提升，人们并没有感觉更幸福，这类似一架“快乐水车”，尽管收入增长，但是幸福却没有同步增长。一个国家的主观幸福感随着经济发展上升到一定程度时，可能出现停滞或下降状态。随着时代的发展，“幸福悖论”也逐渐适用于中国。改革开放40年来，我国GDP持续高速增长，绝大多数居民的生活条件从根本上得到了改善，但是并无证据表明我国居民的幸福感呈现出与经济增长相匹配的提升。因此有必要对中国居民的幸福感进行研究。  
    <p align="right">[*"户籍身份、社会分割与居民幸福感——基于不同影响机制的实证研究"*](http://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CJFQ&dbname=CJFDLAST2019&filename=JJXJ201901012&uid=WEEvREcwSlJHSldRa1FhdkJkVG1BSEZSSWpFSHhPZk1naVBDYnhQWVREST0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!&v=MDM2MDZHNEg5ak1ybzlFWm9SOGVYMUx1eFlTN0RoMVQzcVRyV00xRnJDVVJMT2ZZdWRuRnlybFVyN0pMeWZUWkw=)</p>
  
## **政治背景**
>　　党的十九大报告还特别强调了要把人民群众对美好生活的向往作为永远的奋斗目标，把人民的幸福快乐作为实现中国梦的重要标准，要让人们的幸福感、安全感、获得感更有保障、更充实、 更可持续。如何实现居民幸福感的提升，是各级政府进行社会治理工作需要关注的重要问题
    <p align="right">[*"中国居民的生活方式与主观幸福感研究 ———基于 CGSS2015 数据的实证分析"*](http://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CJFQ&dbname=CJFDPREP&filename=GHXY201901036&uid=WEEvREcwSlJHSldRa1FhdkJkVG1BSEZSSWpFSHhPZk1naVBDYnhQWVREST0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!&v=MDUwMDNMdXhZUzdEaDFUM3FUcldNMUZyQ1VSTE9mWXVkbkZ5cm1VcnZMSWlYVGQ3RzRIOWpNcm85R1lvUjhlWDE=)</p>
  
## **经济背景**
>　　“幸福感数据”被广泛应用于分析微观经济现象和对非市场商品的价值评估中（如健康状况、气候和噪音代价等），同时幸福感可能是经济结果的决定因素：它提高了生产力，预示了未来收入，影响了劳动力市场的表现。越来越多的幸福感研究表明，性格特征在理解幸福感和经济结果间联系方面起着重要作用。同时，相当数量的实证研究表明，幸福感更高的个体通常在工作中有更佳的表现，且在求职过程中也更为顺利
    <p align="right">[*"经济学家为什么研究幸福感？"*](https://mp.weixin.qq.com/s/8Uahhbi6AfRWz6w6WZxqIg)</p>
  
## **社会认知背景**
>　　Akerlof 和Kranton将身份定义为一种社会类别的归属感，同时考虑到该类别中的人应如何行事。例如，一种社会分类是按性别分类，性别身份认同不仅会对男女教育程度差异、性别工资差异产生影响，也会对家庭中家务劳动和家庭权利的分配产生影响，从而影响处于婚姻中个体的生活幸福感。
  <p align="right">[*"家庭内部相对收入、性别身份认同与中国居民生活幸福感——基于CGSS数据的实证研究"*](http://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CJFQ&dbname=CJFDLAST2018&filename=JJPL201806010&uid=WEEvREcwSlJHSldRa1FhdkJkVG1BSEZSSWpFSHhPZk1naVBDYnhQWVREST0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!&v=MDc4ODV4WVM3RGgxVDNxVHJXTTFGckNVUkxPZll1ZG5GeXJtVWJ6Tkx5ZmJZckc0SDluTXFZOUVaSVI4ZVgxTHU=)</p>
　　信仰和价值观对于主观幸福感的影响是不容忽视的，弗洛伊德认为，宗教信仰对个体的思想和行为具有引导功能，宗教文化在精神上的保护功能有利于使得人类感知到幸福。
  <p align="right">[*"宗教信仰、社会支持与居民幸福感——基于CGSS2015数据的实证研究"*](http://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CJFQ&dbname=CJFDLAST2018&filename=RELI201803017&uid=WEEvREcwSlJHSldRa1FhdkJkVG1BSEZSSWpFSHhPZk1naVBDYnhQWVREST0=$9A4hF_YAuvQ5obgVAqNKPCYcEjKensW4IQMovwHtwkF4VYPoHbKxJw!!&v=MjMyMTN5cm1Wci9KTnlqSFo3RzRIOW5Nckk5RVk0UjhlWDFMdXhZUzdEaDFUM3FUcldNMUZyQ1VSTE9mWXVkbkY=)</p>
  
## **现实背景**
>　　据联合国发布的《世界幸福报告》显示,在156个受调查的国家中,2016-2018年中国的幸福感排名93，2010年起我国GDP总量已经超过日本, 成为仅次于美国的世界第二大经济体,但居民的幸福感排名却落后于大多数国家。

```{r}
image_path = "image_one.png"  
rmarkdown::html_notebook_output_img(path = image_path, format = "png")
```
　　从2005-2008到2016-2018，中国的幸福感排名增加了0.426，这表明近年来随着政府对民生问题的关注以及相关政策的实施,我国国民幸福感在逐渐提升。但这一表现仍与我国经济增长速度并不匹配。因此, 有必要进一步研究影响国民幸福感的深层次原因。      

```{r}
image_path = "image_two.png"  
rmarkdown::html_notebook_output_img(path = image_path, format = "png")
```
  　　
　　该报告中幸福感排名是基于对调查中提出的主要生活评估问题的回答。它要求受访者将自己当前的生活评定为0到10级，其中最好的可能生活是10级，最坏的可能生活是0级，这也叫做Cantril阶梯（Cantril Ladder）。此外，报告中统计了另外两个衡量幸福感的指标（积极影响、消极影响）和六个反应居民生活水平的变量。从报告中我们可以发现，中国的Ladder排名为93，Ladder的标准差排名为72，积极影响排名为21，消极影响排名为11，社会支持排名为108，自由程度排名为31，慷慨程度为133，人均GDP排名为68，预期寿命排名为34。 
  
```{r}
image_path = "image_three.png"  
rmarkdown::html_notebook_output_img(path = image_path, format = "png")
```
  <p align="right">[*《世界幸福报告》*](https://s3.amazonaws.com/happiness-report/2019/WHR19.pdf)</p>

# **数据预处理**

## **数据观测**    

1.  读入数据
```{r}
#setwd("C:/Users/ZYJ/Desktop/happinessdata")
library(tidyverse)
data_original<-read.csv("happiness_train_abbr.csv")
```
 
2.  简单观测data的头和尾
```{r}
head(data_original)   #head()输出数据框的前5行
tail(data_original)   #tail()输出数据框的后5行
```
3.  读入变量的含义    

```{r}
data_index<-read.csv("happiness_index_1.csv")
data_index
```
       
4.  查看数据维度  

```{r}
dim(data_original)
```


##  **解析变量**       

1.  观察data_original中变量的类型
```{r}
type<-vector("character",ncol(data_original))
#将每列变量的类型存放到type里
for (i in seq_along(data_original))
{
  type[i]<-class(data_original[[i]])
}
date_type<-data.frame(names=colnames(data_original),type=type)
date_type
#变量在使用前需要初始化
#vector(mode="logical",length=0):构建一个指定类型和长度的向量
#seq_along创建一个从1开始、长度为其输入值的序列
#colnames():获取数据框的列名
```

2.  通过变量含义解析变量的类型
    -  字符型:id  
    -  日期型:survey_time;birth  
    -  数值型:income,floor_area,height_cm,weight_jin,work_y,family_income,family_m,house,car  
    -  因子型:其他

3.   转化变量的类型
```{r}
#通过观察,将“不重复取值的个数”<35的变量转化为因子型变量
data_1<-data_original
for (i in seq_along(data_1))
{
  if(length(table(data_1[[i]]))<35)
    data_1[[i]]<-factor(data_1[[i]])
}
#将id转化为字符型
data_1$id<-as.character(data_1$id)
#将survey_time转化为日期型
data_1$survey_time<-as.Date(data_1$survey_time)
#table():统计每个变量的取值频次
```
     
4.  观察data_1中变量的类型
```{r}
type<-vector("character",ncol(data_1))
for (i in seq_along(data_1))
{
  type[i]<-class(data_1[[i]])
}
date_1_type<-data.frame(names=colnames(data_1),type=type)
date_1_type
```
  
  
  
  发现city,country,family_m,house,car没有被正确解析  

```{r}
data_1$city<-factor(data_1$city)
data_1$family_m<-as.integer(data_1$family_m)
data_1$house<-as.integer(data_1$house)
data_1$car<-as.integer(data_1$car)
```


5.  查看每个变量的取值情况
```{r}
#观察data_1中每个变量的频次分布,将其放入列表中
#list:每个变量的长度数据类型和长度可以不一致
i<-2
mylist<-list()
for (i in seq_along(data_1))
{
  mylist[[i]]<-table(data_1[[i]])
}
names(mylist)<-colnames(data_1)
#mylist 因为数据太长,故不展示
```
   
##  **数据处理**

1.  删去记录       

(1)happiness 
    
```{r}
mylist[["happiness"]]
```

通过观察happiness的取值情况，我们发现有12个记录的happiness取值为-8(无法回答),故删去这12条记录   
   
```{r}
data<-filter(data_1,happiness!=-8)
#filter(data= ,var1= ,...):基于观测的值筛选出一个数据子集
```
     
(2)city&county  
    
```{r}
mylist[["city"]]
mylist[["county"]]
```
通过观察,我们发现city与county中相同取值的观测个数太少,粒度太细,故删去city和county.选取province作为地域的区分

```{r}
data <- subset(data, select = -c(city,county))
#subset():选取子集
#select():选择列,-代表不选择该列
```
         
2.  构造新的变量       

(1)age  
   通过survey_time和birth变量，我们可以求得被调查对象的年龄age.
```{r}
library(lubridate)
survey_year<-year(data$survey_time)
data$age<-survey_year-data$birth
#删去survey_time和birth变量
data <- subset(data, select = -c(survey_time,birth))
#lubridate包处理时间数据
```
  
(2)BMI  
   通过height_cm和weight_jin变量，我们可以求得被调查对象的BMI(体质指数)
```{r}
data$BMI<-(data$weight_jin/2)/(data$height_cm/100)^2
#删去height_cm和weight_jin变量
data <- subset(data, select = -c(height_cm,weight_jin))
```


3.  统一取值  

(1)income
```{r}
head(mylist[["income"]])
```
   
   income中存在-1(不适用),-2(不知道),-3(拒绝回答)的取值,我们将这些取值统一为-8(无法回答)
```{r}
data<-data%>%mutate(income=ifelse(income<0,-8,income))
# %>%:把左边的值发送给右边的表达式,并作为右边表达式函数的第一个参数.例:x%>%f(y)会变成f(x, y),x%>%f(y)%>%g(z)会变成g(f(x, y),z).
# mutate():构造新的变量
```
  
(2)work_status&work_yr&work_type&work_manage  
  
  将这些变量的NA值均修改为-8(无法回答)
```{r}
#将work_status中的NA值改为-8(无法回答)
data<-data%>%mutate(work_status=ifelse(is.na(work_status),-8,work_status))
#将work_yr中的NA值改为-8(无法回答)
data<-data%>%mutate(work_yr=ifelse(is.na(work_yr)|work_yr<0,-8,work_yr))
#work_type中的NA值改为-8(无法回答)
data<-data%>%mutate(work_type=ifelse(is.na(work_type),-8,work_type))
#work_manage中的NA值改为-8(无法回答)
data<-data%>%mutate(work_manage=ifelse(is.na(work_manage),-8,work_manage))
```
  
(3)family_income&family_m&house   
   
   将这些变量的NA值和-1,-2,-3更改为-8(无法回答)
```{r}
#将family_income中的NA值和-1,-2,-3更改为-8(无法回答)
data<-data%>%mutate(family_income=ifelse(is.na(family_income)|family_income<0,-8,family_income))
#将family_m中的NA值和-1,-2,-3更改为-8(无法回答)
data<-data%>%mutate(family_m=ifelse(is.na(family_m)|family_m<0,-8,family_m))
#将house中的NA值更改为-8(无法回答)
data<-data%>%mutate(house=ifelse(house<0,-8,house))
```
   
## **数据摘要**

```{r}
dim(data)
```


```{r}
summary(data)
```

#  **探索性分析EDA**     

```{r}
ggplot(data,aes(x=happiness,fill=happiness))+geom_bar()+theme(aspect.ratio = 1)+coord_polar()
```


## **宗教信仰与幸福感**   

**探索宗教信仰(religion)和参加宗教的频繁程度(religion_freq)与幸福感(happiness)的关联**  

```{r}
#根据religion与happiness绘制热度图
p1<-data %>% 
  count(religion,happiness)%>%
  ggplot(mapping=aes(religion,happiness))+
  geom_tile(mapping=aes(fill=n))+
  labs(title=("religion & happiness"))+
  theme(plot.title = element_text(hjust = 0.5)) 
#用labs()添加标题
#用theme()将标题居中
```


```{r}
#根据religion_freq(参加宗教的频繁程度)和happiness绘制分组条形图
p2<-ggplot(data,aes(x=happiness,fill=religion_freq))+geom_bar(stat="count",position = "dodge",width=0.5)+geom_text(stat="count", aes(label=..count..),position=position_dodge(width=0.5),size=1.5)+xlab("happiness")+ylab("count")+labs(title=("religion_freq & happiness"))+theme(plot.title = element_text(hjust = 0.5)) 
#position="dodge":将每组中的条形图依次并列放置.
```


```{r fig.width=10,fig.height=3}
#将两张图合并为一张
library(ggpubr)
ggarrange(p1,p2,ncol=2,labels=c("(1)","(2)"))
```
       
-  通过图(1),我们可知有宗教信仰的人幸福感更高.通过图(2),我们可知每个等级的幸福感的人都基本不参加宗教活动,故幸福感与参加宗教活动的频繁程度没有太大关联.

##  **生活方式与幸福感**   

**探索以下生活方式社交的频率(socialize),休闲放松的频率(relax),学习充电的频率(learn)与幸福感(happiness)的关联**

```{r}
library(fmsb)
#将happiness,socialize,relax,learn先转化成数值型变量,便于求平均值
data_habbit<-data
data_habbit$happiness<-as.integer(data_habbit$happiness)
data_habbit$socialize<-as.integer(data_habbit$socialize)
data_habbit$relax<-as.integer(data_habbit$relax)
data_habbit$learn<-as.integer(data_habbit$learn)
#分组统计happiness的均值
AvY<-aggregate(data_habbit[,17:19],by=list(data_habbit[,2]),FUN=mean)
#绘制雷达图
radarchart(df=AvY[,2:4],pty=20,plty=8,plwd =2, cglty = 1,cglcol="grey",title = "lifestyle & happiness",vlcex=1,seg=3,maxmin=FALSE,vlabels=colnames(data_habbit[,17:19]),pcol=topo.colors(5),cglwd=0.5,axistype=0)+theme(plot.title = element_text(hjust = 0.5)) 
legend("topright",legend=c("1","2","3","4","5"),col=topo.colors(5),lwd=0.5,inset=c(0.25,0),cex=0.35)
```
       
-  通过三维雷达图我们可以看出,积极进行社交、休闲放松和学习充电的人幸福感更高,且参与程度越频繁,幸福感越高.   
  
## **家庭状况与幸福感**  

**探索婚姻状况(marital)与幸福感(happiness)的关联**

```{r}
data_H<-data
data_H$happiness<-as.integer(data_H$happiness)
AvH<-aggregate(data_H[["happiness"]],by=list(data_H[,32]),FUN=mean)
ggplot(AvH,aes(x=AvH[[1]],y=AvH[[2]]))+geom_point()+labs(title=("marital & happiness"))+theme(plot.title = element_text(hjust = 0.5))+xlab("marital")+ylab("avg_happiness") 
```
   

-  从图中可以看出2(同居)和3(初婚有婚配)的人幸福感高,5(分居未离婚)和6(离婚)的人幸福感较低,可见婚姻状况对幸福感有着明显的影响.      


**探索住房面积(floor_area)与幸福感(happiness)的关联**

```{r}
library(vioplot)
H1<-data$floor_area[data$happiness=='1']
H2<-data$floor_area[data$happiness=='2']
H3<-data$floor_area[data$happiness=='3']
H4<-data$floor_area[data$happiness=='4']
H5<-data$floor_area[data$happiness=='5']
vioplot(H1,H2,H3,H4,H5,col="gold")
title("Floor_area & Happiness",xlab="happiness",ylab="floor_area")
```
     
-   通过该图,我们看出住房面积与幸福感不太相关     

## **健状况康与幸福感**  
- 首先选取与幸福感相关的数据    

```{r}
healthdata <- data[c("happiness","age","BMI","health","health_problem","depression")]
#读入与健康状况相关的数据列
```  

 **探索年龄(age)与幸福感(happiness)的关系**    

```{r}

age_happiness <-data.frame(age=numeric(0),happiness=numeric(0))
# 构建新的数据框，用来存放年龄以及对应年龄样本的幸福感的平均值
for(i in 18:94) #年龄的范围是18-94
{
  agenew <- i
  happiness_meanbyage <- mean(as.numeric(as.character(healthdata$happiness[healthdata$age==i])))
  newcol<-data.frame(age=agenew,happiness=happiness_meanbyage)
  age_happiness <- rbind(age_happiness,newcol)
}
ggplot(data=age_happiness,mapping=aes(x=age,y=happiness))+geom_line()+stat_smooth(fill = "red", size = 2, alpha = 0.5, color = "green")
# 画出年龄与对应幸福感均值的折线图，并画出平滑曲线

```

- 由上图可以看出，随着年龄的增长，幸福感呈先下降再上升的趋势  

**探索年龄(age)与健康状况(health)的关系**

```{r}

age_health <-data.frame(age=numeric(0),health=numeric(0))
#构建新的数据框，用来存放年龄以及对应年龄样本的健康状况的平均值
for(i in 18:94)
{
  agenew <- i
  health_meanbyage <- mean(as.numeric(as.character(healthdata$health[healthdata$age==i])))
  newcol<-data.frame(age=agenew,health=health_meanbyage)
  age_health <- rbind(age_health,newcol)
}
ggplot(data=age_health,mapping=aes(x=age,y=health))+geom_line()+stat_smooth(fill = "red", size = 2, alpha = 0.5, color = "green")
# 画出年龄与对应样本健康状况平均值均值的折线图，并画出平滑曲线

```

- 由上图可以看出，随着年龄的增长，健康状况明显下降  

**探索年龄(age)、健康(health)与幸福感(happiness)的关系**

```{r}

age_happiness_byhealth <- data.frame(age=numeric(0),health=numeric(0),happiness=numeric(0))
# 构建新的数据框，用来存放不同年龄、不同健康状况样本对应幸福感的平均值
for(i in 18:94)
{
  for(j in 1:5)
  {
      agenew <- i
      healthnew <- j
      happinessnew <- mean(as.numeric(as.character(healthdata$happiness[healthdata$age==i&healthdata$health==j])))
      newcol<-data.frame(age=agenew,health=healthnew,happiness=happinessnew)
      age_happiness_byhealth <- rbind(age_happiness_byhealth,newcol)
  }
}
ggplot(age_happiness_byhealth,mapping=aes(x=age,y=happiness,colour=health))+geom_point()
# 画出散点图，年龄为横坐标，幸福感为纵坐标，颜色的深浅代表不同的健康状况

```

- 上图表明，在任何年龄，都是健康状况越好，则幸福感越高  

**探索身体质量指数(BMI)与幸福感(happpiness)的关系**

```{r}

ggplot(healthdata, aes(happiness, BMI))+  
             geom_boxplot(aes(group = cut_width(happiness, 1)), outlier.alpha = 0.5)
# 画出不同幸福感人群的BMI分布箱型图，查看是否有所不同          

```

- 上图表明，五种不同幸福感人群的BMI分布情况大致相同，说明BMI与幸福感水平可能并无显著关系

## **工作状况与幸福感**  

- 选取与工作相关的数据  

```{r}

workdata <- data[c("happiness","work_exper","work_status","work_yr","work_type","work_manage","income")]
# 读入与工作状况和幸福感相关的数据列
```

**探索工作经历(work_exper)与幸福感(happiness)的关系**

```{r}

exper_happiness <-data.frame(work_exper=numeric(0),happiness=numeric(0))
# 构建新的数据框，存放工作经历以及幸福感平均值
name <- c("目前从事非农工作","目前务农，曾经有过非农工作","目前务农，没有过非农工作","目前没有工作，而且只务过农","目前没有工作，曾经有过非农工作","从未工作过")
for(i in 1:6)
{
  work_expernew <- name[i]
  happiness_meanbywork_exper <- mean(as.numeric(as.character(workdata$happiness[workdata$work_exper==i])))
  newcol<-data.frame(work_exper=work_expernew,happiness=happiness_meanbywork_exper)
  exper_happiness <- rbind(exper_happiness,newcol)
}
exper_happiness

```

- 上表表明，不同工作经历的人，幸福感平均值没有显著差异  

**探索工作类型(work_status)与幸福感(happiness)的关系**

```{r}

status_happiness <-data.frame(work_status=numeric(0),happiness=numeric(0))
# 构建新的数据框，存放工作类型以及幸福感平均值
name <- c("自己是老板（或者是合伙人）","个体工商户","受雇于他人（有固定雇主）","劳务工/劳务派遣人员","零工、散工（无固定雇主的受雇者）","在自己家的生意/企业中工作/帮忙，领工资","在自己家的生意/企业中工作/帮忙，不领工资","自由职业者","其他")
for(i in 1:9)
{
  work_statusnew <- name[i]
  happiness_meanbywork_status <- mean(as.numeric(as.character(workdata$happiness[workdata$work_status==i])))
  newcol<-data.frame(work_status=work_statusnew,happiness=happiness_meanbywork_status)
  status_happiness <- rbind(status_happiness,newcol)
}
status_happiness

```

- 上表表明，不同工作状况的人，幸福感平均值没有显著差异    

**探索管理情况(work_manage)与幸福感(happiness)的关系**

```{r}

manage_happiness <-data.frame(work_manage=numeric(0),happiness=numeric(0))
# 构建新的数据框，存放不同管理活动状况以及幸福感平均值
name <- c("只管理别人，不受别人管理","既管理别人，又受别人管理","只受别人管理，不管理别人","既不管理别人，又不受别人管理")
for(i in 1:4)
{
  work_managenew <- name[i]
  happiness_meanbywork_manage <- mean(as.numeric(as.character(workdata$happiness[workdata$work_manage==i])))
  newcol<-data.frame(work_manage=work_managenew,happiness=happiness_meanbywork_manage)
  manage_happiness <- rbind(manage_happiness,newcol)
}
manage_happiness

```

- 上表表明，从事不同管理活动的人，幸福感平均值没有显著差异   

**探索工作年限(work_yr)与幸福感(happiness)的关系**  

```{r}

work_year_happiness <-data.frame(work_year=numeric(0),happiness=numeric(0))
# 构建新的数据框，用来存放不同的工作年限以及其对应样本的幸福感的平均值
for(i in 0:60)
{
  work_yearnew <- i
  happiness_meanbywork_year <- mean(as.numeric(as.character(workdata$happiness[workdata$work_yr==i])))
  newcol<-data.frame(work_year=work_yearnew,happiness=happiness_meanbywork_year)
  work_year_happiness <- rbind(work_year_happiness,newcol)
}
ggplot(data=work_year_happiness,mapping=aes(x=work_year,y=happiness))+geom_line()+stat_smooth(fill = "red", size = 2, alpha = 0.5, color = "green")
# 画出工作年限与对应样本幸福感平均值均值的折线图，并画出平滑曲线

```

- 由图看出，工作年限小于35年时，幸福感并无显著变化，工作年限大于35年后，幸福感呈缓慢上升趋势，这可能与年龄的增长对幸福感造成的影响有关    

**探索工作收入(income)与幸福感(happiness)的关系**    

```{r}

ggplot(workdata, aes(happiness,income,colour=happiness))+coord_flip()+  
             geom_boxplot(aes(group = cut_width(happiness, 1)), outlier.alpha = 0.5)+stat_summary(fun.y=mean, geom="point", shape=1, color="red",size=4)
# 画出不同幸福感样本的收入的箱型图和均值

```

- 由于几个收入极其大的特殊点的存在，导致收入箱型图几乎压缩为一条直线，但是可以看出，这几个特殊点的幸福值处于中等以上水平    

```{r}
workdata$income[workdata$income>250000] <- NA
# 将收入极大的异常点赋值为空
ggplot(workdata, aes(happiness, income,colour=happiness))+coord_flip()+  
             geom_boxplot(aes(group = cut_width(happiness, 1)), outlier.alpha = 0.5)+stat_summary(fun.y=mean, geom="point", shape=1, color="red",size=4)
# 重新画不同幸福感样本的收入箱型图和均值
```
- 为更好的看出不同幸福感人群的收入差异，将上图中几个特殊值改为空，可以看出幸福感较高人群的总体收入情况要略高于幸福感偏低的人群

## **地域因素与幸福感**

**探索省份（province）与幸福感（happiness)的关系**

```{r province}

#根据省份分组查看各省份幸福感均值
happiness_meanp <- summarise(group_by(data,province),meanp=mean(as.numeric(as.character(happiness))))

#添加一个省份名称NAME变量
happiness_meanp$NAME <- NA

#根据问卷含义给NAME赋值
happiness_meanp <- within(happiness_meanp,{
  NAME[province==1] <- "上海市"
  NAME[province==2] <- "云南省"
  NAME[province==3] <- "内蒙古自治区"
  NAME[province==4] <- "北京市"
  NAME[province==5] <- "吉林省"
  NAME[province==6] <- "四川省"
  NAME[province==7] <- "天津市"
  NAME[province==8] <- "宁夏回族自治区"
  NAME[province==9] <- "安徽省"
  NAME[province==10] <- "山东省"
  NAME[province==11] <- "山西省"
  NAME[province==12] <- "广东省"
  NAME[province==13] <- "广西壮族自治区"
  NAME[province==14] <- "新疆维吾尔自治区"
  NAME[province==15] <- "江苏省"
  NAME[province==16] <- "江西省"
  NAME[province==17] <- "河北省"
  NAME[province==18] <- "河南省"
  NAME[province==19] <- "浙江省"
  NAME[province==20] <- "海南省"
  NAME[province==21] <- "湖北省"
  NAME[province==22] <- "湖南省"
  NAME[province==23] <- "甘肃省"
  NAME[province==24] <- "福建省"
  NAME[province==25] <- "西藏自治区"
  NAME[province==26] <- "贵州省"
  NAME[province==27] <- "辽宁省"
  NAME[province==28] <- "重庆市"
  NAME[province==29] <- "陕西省"
  NAME[province==30] <- "青海省"
  NAME[province==31] <- "黑龙江省"
}
  )

#查看各省份幸福感均值
happiness_meanp[c(1,3,2)]
```
-  由表可知，广西壮族自治区的幸福感均值最低为3.623188，河北省幸福感均值最高为4.107143，但各省份总体幸福感均值相差不大。

## **教育因素与幸福感**

**探索教育（edu）与幸福感（happiness)的关系**

```{r edu1}
#根据教育变量分组查看各教育程度幸福感均值
happiness_meane <- summarise(group_by(data,edu),meane=mean(as.numeric(as.character(happiness))))

#添加一个省份名称NAME变量
happiness_meane$MEAN<- NA

#根据问卷含义给NAME赋值
happiness_meane <- within(happiness_meane,{
  MEAN[edu==-8] <- "无法回答"
  MEAN[edu==1] <- "没有受过任何教育"
  MEAN[edu==2] <- "私塾、扫盲班"
  MEAN[edu==3] <- "小学"
  MEAN[edu==4] <- "初中"
  MEAN[edu==5] <- "职业高中"
  MEAN[edu==6] <- "普通高中"
  MEAN[edu==7] <- "中专"  
  MEAN[edu==8] <- "技校"
  MEAN[edu==9] <- "大学专科（成人高等教育）"
  MEAN[edu==10] <- "大学专科（正规高等教育）"
  MEAN[edu==11] <- "大学本科（成人高等教育）"
  MEAN[edu==12] <- "大学本科（正规高等教育）"
  MEAN[edu==13] <- "研究生及以上"
  MEAN[edu==14] <- "其他"
}
  )

happiness_meane[c(1,3,2)]

#查看各教育程度的人数

ggplot(data,aes(x=edu,fill=edu))+
  geom_bar(stat="count")+
  coord_polar(theta = "x", start = 0, direction = 1, clip = "on")

#查看各教育程度的均值

ggplot(data = happiness_meane,mapping=aes(x=edu,y=meane))+
  geom_bar(stat = "identity",fill=topo.colors(length(happiness_meane$edu)))+
  coord_cartesian(ylim=c(3,4.5))



```

-  由图表分析可知，幸福感均值最大致值出现在教育程度为13（研究生及以上）处，且除-8（无法回答）之外，其余教育程度的幸福感均值都在3.5以上，相差不大。因此，从均值上看教育程度在整体上对幸福感产生没有太大影响。

```{r edu2}
#教育变量分类过多，因此我们创建新的教育变量edu1,使分析更加简洁明了

data$edu1 <- NA
data$edu1[as.numeric(as.character(data$edu)) == -8] <- "0 其他"
data$edu1[as.numeric(as.character(data$edu)) > -8 & as.numeric(as.character(data$edu)) <= 3] <- "1 小学及以下"
data$edu1[as.numeric(as.character(data$edu)) == 4] <- "2 初中"
data$edu1[as.numeric(as.character(data$edu)) >= 5&as.numeric(as.character(data$edu)) <= 8] <- "3 高中/职校"
data$edu1[as.numeric(as.character(data$edu)) >= 9&as.numeric(as.character(data$edu)) <= 10] <- "4 专科"
data$edu1[as.numeric(as.character(data$edu)) >= 11&as.numeric(as.character(data$edu)) <= 12] <- "5 本科"
data$edu1[as.numeric(as.character(data$edu)) == 13] <- "6 研究生及以上"
data$edu1 <- as.factor(data$edu1)

#画分组条形图查看各教育程度与各幸福等级的关系

sjPlot::sjp.xtab(data$edu1,data$happiness,show.total = FALSE,show.prc = FALSE,show.n = FALSE)

```
-  由上图可以看出教育程度在小学及以下、初中的群体中，感觉不幸福（happiness<3)的人数占比会大于幸福(happiness>3)的人数，教育程度为初中以上的感到幸福的人数占比会超过不幸福的人数。因此，从单个教育水平来看，教育水平较高的人群中，幸福人数的比重会比较大。

## **社会认知与幸福感**

**探索社会公平（equity）与幸福感（happiness)的关系**

```{r equity}

#查看各社会公平认知水平下不同幸福感的人数分布

data%>%
  count(equity,happiness)%>%
  ggplot(mapping = aes(equity,happiness))+
  geom_tile(mapping = aes(fill=n))

```

-  由热度图可知，比较幸福（happiness=4）且认为社会比较公平（equity=4）的人人数最多。    

```{r fig.width=10,fig.height=6}
sjPlot::sjp.xtab(data$equity,data$happiness,show.total = FALSE,show.prc = TRUE,show.n = FALSE) 
```

-  由上图分析可知，非常不幸福的人中间认为社会完全不公平的占比最多为45.2%；非常幸福的人中间认为社会比较公平的占比最多为53.5%；从整体上看，认为社会比较公平且比较幸福的人占比最多。因此判断社会公平的建设有助于提高公民幸福感。

**探索个人观点与社会观点的一致性（view）与幸福感（happiness)的关系**

```{r view,fig.width=10,fig.height=12}
#画图查看观点一致性与各幸福等级的占比
pic1 <- sjp.xtab(data$happiness,data$view,show.total = FALSE,show.prc = TRUE,show.n = FALSE)
pic2 <- sjp.xtab(data$view,data$happiness,show.total = FALSE,show.prc = TRUE,show.n = FALSE)

ggarrange(pic1,pic2,nrow=2,labels=c("(1)","(2)"))
```
-  如图(1)所示，比较幸福(happiness=4)并且与社会大众观点一致的时候比较多(view=4)的人数占比最多。不幸福(happiness<=2)的群体中，与社会观点基本不一致(view<=3)的人占主导，幸福(happiness>=4)的群体中，与社会观点基本一致(view>=4)的人占主导。  
-  如图(2)所示，与社会观点基本不一致（view<=3）的群体中，感觉不幸福的人数占比会大于幸福的人数，与社会观点基本一致（view>=4）的群体中觉得幸福的人数占比会超过不幸福的人数。

# 建立模型    
      
## 多元线性回归模型   

- 流程：    
    -  利用主成分分析法进行数据降维    
    -  利用提取的主成分进行多元线性回归模型的建立  
    -  回归模型的检验    

###  数据降维:主成分分析法PCA   


1. 数据标准化  

```{r}
library(tidyverse)
data_original<-read.csv("happiness_train_clean.csv")
#取出data中后几列，并将数据标准化,统一量纲
data_new<-scale(data_original[,c(3:38)])
```

2. 判断主成分个数

```{r}
library(psych)
fa.parallel(data_new,n.iter = 100)
#n.iter 随机取n个数据矩阵推导出特征值均值(虚线),以及y=1的水平线
#选取特征根大于1的作为主成分
```

- 根据结果提取11个主成分

3. 提取主成分
```{r} 
pc<-principal(data_new,nfactors = 11,rotate = "none")
pc
#PC1为成分载荷(指观测变量与主成分的相关系数),若提取的主成分大于1,则会出现PC2、PC3等,成分载荷可以解释主成分与各变量的相关程度.  
#h2栏为成分公因子方差,即主成分对每个变量的方差解释  
#u2栏为成分唯一性,即方差无法被主成分解释的部分(1-h2) #SS loadings:公共因子对变量X的总方差贡献  
#Proportion Var:方差贡献率  
#Cumulative Var:累积方差贡献率  
#Proportion Explained:按现有总解释方差百分比划分主成分  
#Cumulative Proportion:累积百分比
```

   
4. 主成分旋转  

- 旋转是一系列将成分载荷阵变得更容易解释的数学方法,其中正交旋转是方差极大旋转,它试图对载荷阵的列进行去 噪,使得每个成分只是由一组有限的变量来解释(即载荷阵每列只有少数几个很大的载荷，其他 都是很小的载荷)。  

```{r}
rc<-principal(data_new,nfactors = 11,rotate = "varimax")
rc
```

- 根据因子载荷矩阵,我们可以得到如下结论:    
    1). PC1在work_exper,work_status,work_yr,work_type,work_manage这五个变量上的载荷较大,可以解释为"工作"变量,解释了happiness变量13%的方差.    
    2). PC2在equity,class,family_status和view这四个变量上的载荷较大,可以解释为"社会认知"变量,解释了happiness变量4%的方差.    
    3). PC3在survey_type和hukou这两个变量上的载荷较大,可以解释为"地域"变量,解释了happiness变量6%的方差.  
    4). PC4在marital和age这两个变量上的载荷较大,可以解释为"婚姻"变量,解释了happiness变量6%的方差.    
    5). PC5在status_peer和status_3_before这两个变量上的载荷较大,可以解释为"社会地位"变量,解释了happiness变量4%的方差.  
    6). PC6在health,health_problem和depression这两个变量上的载荷较大,可以解释为"健康"变量,解释了happiness变量5%的方差.  
    7). PC7在nationality,religion和religion_freq这3个变量上的载荷较大,可以解释为"信仰"变量,解释了happiness变量3%的方差.   
    8). PC8在socialize和relax这两个变量上的载荷较大,可以解释为"休闲"变量,解释了happiness变量4%的方差.   
    9). PC9在gender这个变量上的载荷较大,可以解释为"性别"变量,解释了happiness变量4%的方差.  
    10). PC10在floor_area,family_m和car这三个变量上的载荷较大,可以解释为"体重指数"变量,解释了happiness变量4%的方差.   
    11). PC11在income和family_income这两个变量上的载荷较大,可以解释为"收入"变量,解释了happiness变量3%的方差.       
    综上,11个主成分旋转后的累积方差解释性为57%

5. 获取主成分得分

```{r}
library(psych)
unclass(rc$weights)
```



## 多元线性回归  

1. 将原始数据转化为11个因子
```{r}
score<-rc$weights #得分计算矩阵
ef<-data_new%*%score #将原数据转化11个因子
mydata<-cbind(ef,data_original$happiness)
```

2. 拟合多元线性回归模型  

```{r}
mydata_frame<-as.data.frame(mydata) #回顾需要数据框，先将数据从矩阵转化为数据框
fit <- lm(V12 ~ RC1+RC2+RC3+RC4+RC5+RC6+RC7+RC8+RC9+RC10+RC11,data=mydata_frame)
summary(fit)
```

- 其中RC7和RC9的p值大于0.05,说明RC7与RC9对happiness无显著性影响.  

3. 剔除变量,重新拟合回归模型  

```{r}
newfit <- lm(V12 ~ RC1+RC2+RC3+RC4+RC5+RC6+RC8+RC10+RC11,data=mydata_frame)
summary(newfit)
```

## 回归诊断   

- 为了能够恰当地解释OLS模型的系数，数据必须满足以下统计假设：  
    1).  正态性:对于固定的自变量值,因变量值成正态分.
    2).  独立性:Yi值之间相互独立.  
    3).  线性:因变量与自变量之间为线性相关.  
    4).  同方差性:因变量的方差不随自变量的水平不同而变化. 
    

1. 正态性  

```{r}
library(car)
qqPlot(newfit,labels=row.names(mydata_frame),id.method="identify",simulate=T,main="Q-Q Plot")
```

- Q-Q图主要用来检验样本是否近似服从正态分布.对于标准状态分布而言,Q-Q图上的点近似在Y=X直线附近,该直线的斜率为标准差,截距为均值. 由图可知,我们拟合的曲线不符合正态分布.   

2. 误差的独立性
```{r}
#Durbin—Watson检验:检测误差的序列相关性
durbinWatsonTest(newfit)
```
  
- p=0.802>0.05,说明P值不显著,变量间有自相关性,误差项之间不独立.其中,滞后项(lag=1)表明数据集中每个数据都是与其后一个数据进行比较的.  

3. 同方差性     

- 异方差:某一因素或某些因素随着解释变量观测值的变化而对被解释变量产生不同的影响,导致随机误差产生不同方差.      
- 残差图分析法是一种直观、方便的分析方法.它以残差为纵坐标,以样本拟合值为横坐标画散点图,主要用来检验是否存在异方差.    

```{r}
ncvTest(newfit)
#p值不显著 满足方差不变假设
spreadLevelPlot(newfit)
```
   
- 由图可知,残差图上的点的散布呈现出一定趋势（随横坐标的增大而增大或减小）,则可以判断回归模型存在异方差.
     
     
4. 线性模型假设的综合验证
```{r}
library(gvlma)
gvmodel<-gvlma(newfit)
summary(gvmodel)
```

- 不满足Global Stat,SkewneSs(偏斜度)、Kurtosis(峰度的假设);满足Link Function(链结函数)和Heterosecdasticity(异方差性)的假设.


## 广义线性模型扩展：泊松回归  

- 当通过一系列连续型和/或类别型预测变量来预测计数型因变量时，泊松回归是常用的工具   

```{r}
#根据前面探索性分析的结果，我们选取宗教、婚姻、健康、年龄、收入、社会认知6个自变量进行回归
glm_data <- data[c("happiness","religion","marital","health","age","income","equity","inc_ability")]

#为进行回归分析，需将因子型变量值为-8的行删去
glm_data <- glm_data%>%filter(religion != -8,marital != -8,health != -8,age != -8,income != -8,equity != -8,inc_ability != -8)

#为接下来图标更加值观，将因子型变量的类别编号改为其实际含义
glm_data$religion <- as.character(glm_data$religion)
glm_data$marital <- as.character(glm_data$marital)
glm_data$health <- as.character(glm_data$health)
glm_data$equity <- as.character(glm_data$equity)
glm_data$inc_ability <- as.character(glm_data$inc_ability)
glm_data$religion[as.numeric(glm_data$religion)==0] <- "0 无宗教" 
glm_data$religion[as.numeric(glm_data$religion)==1] <- "1 有宗教"
glm_data$marital[as.numeric(glm_data$marital)==1] <- "1 未婚"
glm_data$marital[as.numeric(glm_data$marital)==2] <- "2 同居"
glm_data$marital[as.numeric(glm_data$marital)==3] <- "3 初婚有配偶"
glm_data$marital[as.numeric(glm_data$marital)==4] <- "4 再婚有配偶"
glm_data$marital[as.numeric(glm_data$marital)==5] <- "5 分居未离婚"
glm_data$marital[as.numeric(glm_data$marital)==6] <- "6 离婚"
glm_data$marital[as.numeric(glm_data$marital)==7] <- "7 丧偶"
glm_data$health[as.numeric(glm_data$health)==1] <- "1 很不健康"
glm_data$health[as.numeric(glm_data$health)==2] <- "2 比较不健康"
glm_data$health[as.numeric(glm_data$health)==3] <- "3 一般"
glm_data$health[as.numeric(glm_data$health)==4] <- "4 比较健康"
glm_data$health[as.numeric(glm_data$health)==5] <- "5 很健康"
glm_data$equity[as.numeric(glm_data$equity)==1] <- "1 完全不公平"
glm_data$equity[as.numeric(glm_data$equity)==2] <- "2 比较不公平"
glm_data$equity[as.numeric(glm_data$equity)==3] <- "3 说不上公平不公平"
glm_data$equity[as.numeric(glm_data$equity)==4] <- "4 比较公平"
glm_data$equity[as.numeric(glm_data$equity)==5] <- "5 完全公平"
glm_data$inc_ability[as.numeric(glm_data$inc_ability)==1] <- "1 非常合理"
glm_data$inc_ability[as.numeric(glm_data$inc_ability)==2] <- "2 合理"
glm_data$inc_ability[as.numeric(glm_data$inc_ability)==3] <- "3 非常合理"
glm_data$inc_ability[as.numeric(glm_data$inc_ability)==4] <- "4 非常不合理"
glm_data$religion <- factor(glm_data$religion)
glm_data$marital <- factor(glm_data$marital)
glm_data$health <- factor(glm_data$health)
glm_data$equity <- factor(glm_data$equity)
glm_data$inc_ability <- factor(glm_data$inc_ability)

#为方便实用该模型，将幸福感变为数值型，将收入取对数
glm_data$income <- log(glm_data$income+1)
glm_data$happiness <- as.numeric(as.character(glm_data$happiness))

#加载需要的包
library(stargazer)
library(sjPlot)
library(ggeffects)

#查看整理好用于泊松回归的数据集
glm_data
```

**不考虑变量间交互影响，生成模型**  

```{r}
#不考虑变量间交互，生成模型1
model1 <- glm(happiness~religion+marital+health+age+income+equity+inc_ability,data=glm_data,family = poisson())
summary(model1)
```

- 由模型可以看出，健康状况、社会公平、收入合理性对幸福感有显著影响  
- 对比参照组（很不健康），个体越健康，处于较高幸福感的可能性就越大  
- 对比参照组（认为社会非常不公平），个体越认为社会公平，处于较高幸福感的可能性越大  
- 对比参照组（认为收入非常合理），个体认为收入越不合理，处于较高幸福感的可能性越小  

**考虑变量间可能存在的交互影响，重新生成模型**    

```{r}
#交互影响：即当影响行为的一个因子与另一个因子共同起作用时，它们对该行为产生与各自单独作用时截然不同的影响。例如：A对C有作用，B对C有作用，当A与B联合（A*B）时，对C产生协同或拮抗作用，这种作用称为交互作用。如果A与B对C不产生这作用，则不存在交互作用
model2 <- glm(happiness~religion+marital+health+age+income+equity+inc_ability+age*health+age*income+health*income,data=glm_data,family = poisson())
summary(model2)
```

- 由上述结果可以看出，健康状况、社会公平、收入合理性对幸福感依然有显著影响，交互作用对模型的影响不显著  

**模型可视化**      

```{r}
#用图形直观查看健康对幸福感的影响
dat1 <-ggpredict(model2,terms=list("health"))
plot(dat1,facet=TRUE)+geom_line()
```

- 由图可看出，健康对幸福感有显著正面影响    

```{r}
#用图形直观查看收入和健康对幸福感的交互影响
dat2 <- ggpredict(model2,terms = list("income","health"))
P1 <- plot(dat2,facet=TRUE)+geom_line()
#用图形直观查看年龄和健康对幸福感的交互影响
dat3 <- ggpredict(model2,terms = list("age","health"))
P2 <- plot(dat3,facet=TRUE)+geom_line()
#将两张图并列放置
library(ggpubr)
ggarrange(P1,P2,ncol=2,labels=c("(1)","(2)"))
```

- 由图可以看出，在控制了其他变量的基础上，收入、年龄对幸福感的影响总体来说并不十分显著（只有当健康状况为很不健康时，幸福感变化较大）    

**逐步回归**  
```{r}
model3 <- step(model2)
summary(model3)
```

- 逐步回归由系统自动挑选最佳的回归方程，我们可以看到系统自动去掉了不显著的交互项，级该交互效应在我们所研究的问题上没有统计学上的意义。    


## **有序因变量回归**

### **模型构建和分析**

**对于有次序的分类变量或者离散变量可以采用有序因变量回归。 该模型可以提供高低不同层次之间的两两比较和累积概率**   
**一般而言，回归系数β>0表明随解释变量正向变化，选择将、较高等级的可能性增加，选择较低等级的可能性下降；若回归系数β<0,反之。**

```{r ordinal_regression}

library(ordinal)
#去除异常值-8
fmdata <- data%>%
  filter(health != -8,edu != -8,equity != -8,view != -8,inc_ability != -8)

#对收入进行对数变换，减少多重共线性，并在一定程度上消除量纲的影响
fmdata$income1 <- log(fmdata$income + 1)

#未回答的收入值-8进行对数变换后会产生NaN值，会影响回归分析，此处我们去掉含NaN记录
fmdata <- na.omit(fmdata)

#构建一个新的变量happy存储happiness含义
fmdata$happy <- NA
fmdata$happiness <- as.character(fmdata$happiness)
fmdata$happy[as.numeric(fmdata$happiness)==1] <- "1 非常不幸福"
fmdata$happy[as.numeric(fmdata$happiness)==2] <- "2 比较不幸福"
fmdata$happy[as.numeric(fmdata$happiness)==3] <- "3 说不上幸福不幸福"
fmdata$happy[as.numeric(fmdata$happiness)==4] <- "4 比较幸福"
fmdata$happy[as.numeric(fmdata$happiness)==5] <- "5 非常幸福"
fmdata$happiness <- as.factor(fmdata$happiness)
fmdata$happy <- as.factor(fmdata$happy)

#给变量重新赋值，使结果显示更明显

fmdata$survey_type <- as.character(fmdata$survey_type)
fmdata$survey_type[as.numeric(fmdata$survey_type)==1] <- "1 城市"
fmdata$survey_type[as.numeric(fmdata$survey_type)==2] <- "2 农村"
fmdata$survey_type <- as.factor(fmdata$survey_type)

fmdata$gender <- as.character(fmdata$gender)
fmdata$gender[as.numeric(fmdata$gender)==1] <- "1 男"
fmdata$gender[as.numeric(fmdata$gender)==2] <- "2 女"
fmdata$gender <- as.factor(fmdata$gender)

fmdata$health <- as.character(fmdata$health)
fmdata$health[as.numeric(fmdata$health)==1] <- "1 很不健康"
fmdata$health[as.numeric(fmdata$health)==2] <- "2 比较不健康"
fmdata$health[as.numeric(fmdata$health)==3] <- "3 一般"
fmdata$health[as.numeric(fmdata$health)==4] <- "4 比较健康"
fmdata$health[as.numeric(fmdata$health)==5] <- "5 很健康"
fmdata$health <- as.factor(fmdata$health)

fmdata$equity <- as.character(fmdata$equity)
fmdata$equity[as.numeric(fmdata$equity)==1] <- "1 完全不公平"
fmdata$equity[as.numeric(fmdata$equity)==2] <- "2 比较不公平"
fmdata$equity[as.numeric(fmdata$equity)==3] <- "3 说不上公平不公平"
fmdata$equity[as.numeric(fmdata$equity)==4] <- "4 比较公平"
fmdata$equity[as.numeric(fmdata$equity)==5] <- "5 完全公平"
fmdata$equity <- as.factor(fmdata$equity)

fmdata$view <- as.character(fmdata$view)
fmdata$view[as.numeric(fmdata$view)==1] <- "1 非常少"
fmdata$view[as.numeric(fmdata$view)==2] <- "2 比较少"
fmdata$view[as.numeric(fmdata$view)==3] <- "3 一般"
fmdata$view[as.numeric(fmdata$view)==4] <- "4 比较多"
fmdata$view[as.numeric(fmdata$view)==5] <- "5 非常多"
fmdata$view <- as.factor(fmdata$view)

fmdata$inc_ability <- as.character(fmdata$inc_ability)
fmdata$inc_ability[as.numeric(fmdata$inc_ability)==1] <- "1 非常合理"
fmdata$inc_ability[as.numeric(fmdata$inc_ability)==2] <- "2 合理"
fmdata$inc_ability[as.numeric(fmdata$inc_ability)==3] <- "3 不合理"
fmdata$inc_ability[as.numeric(fmdata$inc_ability)==4] <- "4 非常不合理"
fmdata$inc_ability <- as.factor(fmdata$inc_ability)


#选用cumalative link model模型进行拟合
fm1 <- clm(happy~survey_type+gender+edu1+income1+health+equity+view+inc_ability,data=fmdata)

summary(fm1)
```

-  由拟合结果分析可知，性别、身体状况、社会公平性、收入合理性等因素对幸福感有显著影响
-  对比男性，女性更倾向于选择较高的幸福感选项
-  对比参照组（很不健康），个体越健康，处于较高幸福感的可能性就越大
-  对比参照组（认为社会非常不公平），个体越认为社会公平，处于较高幸福感的可能性越大
-  对比参照组（认为收入非常合理），个体认为收入越不合理，处于较高幸福感的可能性越小

```{r}
#加入收入合理性与收入的交互项inc_ability:income1，检验其是否有交互效应
fm2 <- clm(happy~survey_type+gender+edu1+income1+health+equity+view+inc_ability+inc_ability:income1,data=fmdata)
summary(fm2)

```

-  结果显示，收入合理性与收入的交互效应并不显著

```{r}
#逐步回归
fm3 <- step(fm2)
summary(fm3)
```

-  由逐步回归结果可得happiness ~ survey_type + gender + edu1 + income1 + health + equity + view + inc_ability，去掉了不显著的交互项inc_ability:income1。

### **模型结果可视化**
```{r visualize}
library(ggeffects)

dat1 <- ggpredict(fm3,terms = list("health"))
plot(dat1,facet = TRUE)+
  geom_line()+
  theme(axis.text.x = element_text(angle = 30,hjust = 1))
```

-  每一个图画框代表一个幸福水平下不同健康效果的效应。1 非常不幸福水平下，每个健康水平的个体概率相差不大; 2 比较不幸福水平下，各健康水平选择它的概率也较为平均，很不健康的人选择它的概率会相对较大;3 说不上幸福不幸福水平下，很不健康的人选择它的概率较大，后随健康水平提高概率逐渐减小;4 比较幸福水平下，各健康水平选择它的概率都较大，随健康水平提高，概率呈上升趋势;5 非常幸福水平下，各健康水平的群体选择它的概率随健康水平提高而上升。 

```{r}
dat2 <- ggpredict(fm3,terms = list("gender"))
plot(dat2,facet = TRUE)+
  geom_line()
```

-  各层次幸福感中，性别体现的差距不大。

```{r}
dat3 <- ggpredict(fm3,terms = list("income1"))
plot(dat3,facet = TRUE)+
  geom_line()
```

-  由图分析，工资水平越高，其选择的高等级幸福感的概率会越大。



## 决策树  

```{r}
library(ROSE)
# 在决策树中，我们采用和泊松回归同样的变量，将泊松回归整理过的数据集读入
tree_data <- glm_data
#将幸福感重新转换为因子型
tree_data$happiness <- factor(tree_data$happiness)
#由于模型需要，将幸福感分为“happy”和“unhappy”分成两类
tree_data$happiness <- as.character(tree_data$happiness)
tree_data$happiness[tree_data$happiness==1|tree_data$happiness==2|tree_data$happiness==3] <- "unhappy"
tree_data$happiness[tree_data$happiness==4|tree_data$happiness==5] <- "happy"
tree_data$happiness <- factor(tree_data$happiness)
summary(tree_data$happiness)
```
- 我们看到，幸福与不幸福的数据量差距较大，数据可能存在不平衡   

**平衡数据**

```{r}
#平衡数据
rose_train <- ROSE(happiness~religion+marital+health+age+income+equity+inc_ability,data=tree_data)
#将平衡后数据的类型从ROSE型变成数据框
rose_train <- data.frame(rose_train$data)
summary(rose_train$happiness)
```
- 可以看出平衡过后的数据基本达到平衡  

**生成决策树**   

```{r}
library(caret)
library(rpart)
library(rattle)
#利用原使不平衡的数据生成决策树
rpart1 <- train(happiness~religion+marital+health+age+income+equity+inc_ability,data=tree_data,"rpart")
#利用平衡后的数据生成决策树
rpart2 <- train(happiness~religion+marital+health+age+income+equity+inc_ability,data=rose_train,"rpart")
#混淆矩阵
confusionMatrix(rpart1)
confusionMatrix(rpart2)
```
- 可以看出，对于未平衡的数据，正确率未79.18%，对于平衡后的数据集，正确率为66.98%    
- 这主要是由于在非平衡数据中，模型倾向于将绝大部分（共有75.1% + 17.3% = 92.4%）的数据预测为幸福,而在平衡数据中，尽管正确率降低，但还是高于随机猜测的    

## 输入决策模型并可视化  

```{r}
library(rpart.plot)
print(rpart1$finalModel)
rpart.plot(rpart1$finalModel,extra=0,tweak=1,type=1)
```
  
- 对于非平衡数据生成的决策树较为复杂  

```{r}
print(rpart2$finalModel)
rpart.plot(rpart2$finalModel,extra=0,tweak=1,type=1)
```
  
- 可以看出，这是一颗叶节点为3的决策树，这个简单的决策树预测模型的结论是，公平和健康是预测幸福感的重要因素


## **神经网络建模分析**
    
```{r balance data}
library(ROSE)
library(caret)
#非平衡数据处理

BPdata <- fmdata[c("happiness","survey_type","gender","edu1","income","health","equity","view","inc_ability")]

#将因子变量转换为数值变量，便于回归分析
BPdata$happyn <- NA
BPdata$happyn <- as.numeric(levels(BPdata$happiness))[BPdata$happiness]
BPdata$income1 <- log(BPdata$income+1)

#样本数据不平衡会影响预测结果准确性
BPdata$newhappy <- NA
BPdata$newhappy[BPdata$happyn <= 3] <- "unhappy"
BPdata$newhappy[BPdata$happyn >= 4] <- "happy"
plot_frq(BPdata$newhappy)

rose_train <- ROSE(newhappy~survey_type+gender+edu1+income1+health+equity+view+inc_ability,data=BPdata)
plot_frq(rose_train$data$newhappy)
  #ROSE(formula, data, N, p=0.5, hmult.majo=1, hmult.mino=1,...)
  #通过扩大少数类和多数类样本的特征空间来创建合成数据的样本。

```
```{r BP,results="hide"}
nnet <- train(newhappy~survey_type+gender+edu1+income1+health+equity+view+inc_ability,data=rose_train$data,"nnet")
```

```{r}
confusionMatrix(nnet)
```

-  使用nnet预测的成功概率为69.66%，大于随机猜测50%，因此认为神经网络预测效果较好。

**模拟人脑神经网络反射图**

```{r fig.width=17,fig.height=16}
library(NeuralNetTools)
plotnet(nnet)
```

**图形输出查看变量影响力**
```{r fig.width=10}
garson(nnet)+
  theme(axis.text.x = element_text(angle = 50,hjust = 1))
```

-  由上图对神经网络预测过程中变量重要性的排序，可以看出，健康是排在第一位的，社会公平、社会观点一致性、收入公平性等因素紧随其后。

# **GitHub工作总结**

**1  使用步骤**

-  注册GitHub
-  由一组员新建Organization并邀请组员
-  在组织中创建仓库
-  安装Git并配置ssh key
-  将ssh key添加到Organization的deploy key中
-  远程仓库使用  
   -  在git bash中输入git init命令初始化git
   -  使用git add file添加文件并使用git commit -m "informantion"输入提交信息
   -  使用git remote add origin git@github.com:yourName/yourRepo.git添加远程仓库
   -  使用git push origin master提交到Github
   -  提交文件成功
-  后续同步远程仓库与本地仓库使用git fetch和git merge命令
-  注：提交文件及更新操作也可以直接在网页端进行提交和编辑

-  **[团队仓库地址](https://github.com/bdanalysisc)**

**2  遇到的问题及解决措施**

>$ git push origin master    
To github.com:bdanalysisc/test.git   
 ! [rejected]        master -> master (non-fast-forward)  
error: failed to push some refs to 'git@github.com:bdanalysisc/test.git'    
hint: Updates were rejected because the tip of your current branch is behind  
hint: its remote counterpart. Integrate the remote changes (e.g.  
hint: 'git pull ...') before pushing again.  
hint: See the 'Note about fast-forwards' in 'git push --help' for details.

-  问题1：提交文件至GitHub时出现如上错误提示
   -  原因：在建立本地仓库与远程仓库联系时，两个仓库内含不同文件，需要合并
   -  **解决措施: $  git pull origin master --allow-unrelated-histories**  
   
  
-  问题2：组织成员无法提交修改，只能提出pull request
   -  原因：该成员在该仓库权限为read，无法修改
   -  **解决措施：组织拥有者在组织的设置里把该成员的Member Privilege设置成Write或者Admin**
   
**3  工作感想与总结**

-  GitHub是一个很好用的项目托管平台，与git结合使用对于文件更新操作十分便利。
-  使用Organization团队成员可以及时沟通项目进度，汇总文档。
-  在大批量上传文件时，建议直接在网页端上传，会比用git添加文件更方便。对某文档进行更新操作时，使用git merge更方便。
